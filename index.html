<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Convertir Texto para Imprimir</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <!-- MathJax -->
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                tags: 'none'
            },
            svg: {
                fontCache: 'global'
            },
            startup: {
                ready: () => {
                    MathJax.startup.defaultReady();
                    MathJax.typesetPromise();
                }
            }
        };
    </script>

    <style>
        /* Estilos generales */
        body {
            font-family: 'Roboto', sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background: url('https://cms.henryford.edu.ar/uploads/portada_3368f54830.webp') no-repeat center center fixed;
            background-size: cover;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 1400px;
            margin: 20px auto;
        }

        .logo-container {
            text-align: center;
            margin: 0 auto 20px;
            width: 100%;
        }

        .logo-container1 {
            text-align: center;
            margin: 0 auto 20px;
            width: 100%;
        }

        .logo-container img {
            width: 120px;
            height: auto;
            display: block;
            margin: 0 auto;
        }

        .logo-container1 img {
            width: 60px;
            height: auto;
            display: block;
            margin: 0 auto;
        }

        h1 {
            color: #007bff;
            text-align: center;
            margin-bottom: 30px;
        }

        textarea {
            width: 100%;
            height: 80px;
            padding: 15px;
            margin-bottom: 20px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            resize: vertical;
            box-sizing: border-box;
            font-family: 'Roboto', sans-serif;
        }

        textarea:focus {
            border-color: #007bff;
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo-container no-print">
            <img src="https://www.henryford.edu.ar/uploads/logo512_f4b4cdb9e9.png" alt="Logo Henry Ford" id="headerLogo">
        </div>
        <h1 class="no-print">Editá - Imprimí - Descargá</h1>
        
        <textarea id="rubricaInput" class="no-print" placeholder="Pegá aquí el texto generado por la IA..."></textarea>
      <style>
    /* Estilos de la barra de herramientas */
    .editor-toolbar {
        position: sticky;
        top: 0;
        z-index: 1000;
        background: rgba(248, 249, 250, 0.95);
        backdrop-filter: blur(8px);
        padding: 10px;
        border-radius: 8px;
        margin: 20px 0;
        border: 1px solid #ddd;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: box-shadow 0.3s ease;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }

    .editor-toolbar.sticky {
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .toolbar-group {
        display: flex;
        gap: 5px;
        align-items: center;
        padding-right: 10px;
        border-right: 1px solid #ddd;
    }

    .toolbar-group:last-child {
        border-right: none;
    }

    .tool-button {
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 6px 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 14px;
        transition: all 0.2s ease;
    }

    .tool-button:hover {
        background: #e9ecef;
        border-color: #adb5bd;
    }

    .tool-button.active {
        background: #007bff;
        color: white;
        border-color: #0056b3;
    }

    .tool-button i {
        font-size: 14px;
    }

    .color-picker {
        width: 30px;
        height: 30px;
        padding: 2px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        background-color: white;
    }

    .color-picker::-webkit-color-swatch {
        border: none;
        border-radius: 2px;
        padding: 0;
    }

    .color-picker::-webkit-color-swatch-wrapper {
        border: none;
        border-radius: 2px;
        padding: 0;
    }

    .font-size-selector {
        padding: 6px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background: white;
        font-size: 14px;
        cursor: pointer;
    }

    /* Botones principales */
    .buttons-container {
        display: flex;
        gap: 20px;
        justify-content: center;
        margin: 20px 0;
    }

    .button {
        background: linear-gradient(to bottom, #007bff, #0056b3);
        color: white;
        border: none;
        padding: 15px 30px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 18px;
        font-weight: bold;
        min-width: 200px;
        transition: all 0.2s ease;
    }

    .button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    #clearButton {
        background: linear-gradient(to bottom, #dc3545, #bd2130);
    }

    #printButton {
        background: linear-gradient(to bottom, #28a745, #1e7e34);
    }

    #downloadButton {
        background: linear-gradient(to bottom, #007bff, #0056b3);
    }

    /* Área de previsualización */
    .preview-content {
        margin: 20px auto;
        padding: 40px;
        background: white;
        border-radius: 8px;
        display: none;
        width: 100%;
        box-sizing: border-box;
    }

    #contenidoRubrica {
        min-height: 200px;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-top: 20px;
        outline: none;
    }

    #contenidoRubrica:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
    }

    /* Grabación */
    .recording {
        animation: pulse 1.5s infinite;
        background: #dc3545 !important;
        color: white !important;
    }

    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
</style>

<div class="buttons-container no-print">
    <button class="button" id="printButton" onclick="imprimirContenido()">
        <i class="fas fa-print"></i> Imprimir
    </button>
    <button class="button" id="downloadButton" onclick="descargarContenido()">
        <i class="fas fa-download"></i> Descargar
    </button>
    <button class="button" id="clearButton" onclick="borrarContenido()">
        <i class="fas fa-trash"></i> Borrar
    </button>
</div>
      <!-- Barra de herramientas -->
<div class="editor-toolbar no-print">
    <div class="toolbar-group">
        <!-- Formato de Texto Básico -->
        <button class="tool-button" onclick="formatText('bold')" title="Negrita">
            <i class="fas fa-bold"></i>
        </button>
        <button class="tool-button" onclick="formatText('italic')" title="Cursiva">
            <i class="fas fa-italic"></i>
        </button>
        <button class="tool-button" onclick="formatText('underline')" title="Subrayado">
            <i class="fas fa-underline"></i>
        </button>
        <button class="tool-button" onclick="formatText('strikethrough')" title="Tachado">
            <i class="fas fa-strikethrough"></i>
        </button>
    </div>

    <div class="toolbar-group">
        <!-- Color de Texto y Resaltado -->
        <input type="color" class="color-picker" onchange="changeColor(this.value)" title="Color de texto">
        <input type="color" class="color-picker" id="highlightColorPicker" value="#ffff00" title="Color de resaltado">
        <button class="tool-button" onclick="applyHighlight()" title="Resaltar">
            <i class="fas fa-highlighter"></i>
        </button>
    </div>

    <div class="toolbar-group">
        <!-- Alineación de Texto -->
        <button class="tool-button" onclick="formatText('justifyLeft')" title="Alinear a la izquierda">
            <i class="fas fa-align-left"></i>
        </button>
        <button class="tool-button" onclick="formatText('justifyCenter')" title="Centrar">
            <i class="fas fa-align-center"></i>
        </button>
        <button class="tool-button" onclick="formatText('justifyRight')" title="Alinear a la derecha">
            <i class="fas fa-align-right"></i>
        </button>
        <button class="tool-button" onclick="formatText('justifyFull')" title="Justificar">
            <i class="fas fa-align-justify"></i>
        </button>
    </div>

    <div class="toolbar-group">
        <!-- Herramientas de Inserción -->
        <button class="tool-button" onclick="insertLink()" title="Insertar enlace">
            <i class="fas fa-link"></i>
        </button>
        <button class="tool-button" onclick="insertImage()" title="Insertar imagen">
            <i class="fas fa-image"></i>
        </button>
        <button class="tool-button" onclick="insertVideo()" title="Insertar video">
            <i class="fas fa-video"></i>
        </button>
        <button class="tool-button" onclick="insertIframe()" title="Insertar iframe">
            <i class="fas fa-code"></i>
        </button>
    </div>

    <div class="toolbar-group media-tools" style="display: none;">
        <!-- Ajuste de Tamaño de Medios -->
        <button class="tool-button" onclick="adjustMediaSize('decrease')" title="Reducir tamaño">
            <i class="fas fa-compress-arrows-alt"></i>
        </button>
        <button class="tool-button" onclick="adjustMediaSize('increase')" title="Aumentar tamaño">
            <i class="fas fa-expand-arrows-alt"></i>
        </button>
        <button class="tool-button" onclick="alignMedia('left')" title="Alinear a la izquierda">
            <i class="fas fa-align-left"></i>
        </button>
        <button class="tool-button" onclick="alignMedia('center')" title="Centrar">
            <i class="fas fa-align-center"></i>
        </button>
        <button class="tool-button" onclick="alignMedia('right')" title="Alinear a la derecha">
            <i class="fas fa-align-right"></i>
        </button>
    </div>

    <div class="toolbar-group">
        <!-- Listas y Sangría -->
        <button class="tool-button" onclick="formatText('insertUnorderedList')" title="Lista con viñetas">
            <i class="fas fa-list-ul"></i>
        </button>
        <button class="tool-button" onclick="formatText('insertOrderedList')" title="Lista numerada">
            <i class="fas fa-list-ol"></i>
        </button>
        <button class="tool-button" onclick="formatText('indent')" title="Aumentar sangría">
            <i class="fas fa-indent"></i>
        </button>
        <button class="tool-button" onclick="formatText('outdent')" title="Disminuir sangría">
            <i class="fas fa-outdent"></i>
        </button>
    </div>

    <div class="toolbar-group">
        <!-- Tamaño de Fuente -->
        <select class="font-size-selector" onchange="changeFontSize(this.value)" title="Tamaño de fuente">
            <option value="">Tamaño de texto</option>
            <option value="1">Muy pequeño</option>
            <option value="2">Pequeño</option>
            <option value="3">Normal</option>
            <option value="4">Grande</option>
            <option value="5">Más grande</option>
            <option value="6">Muy grande</option>
            <option value="7">Máximo</option>
        </select>
    </div>

    <div class="toolbar-group">
        <!-- Grabación de Audio y Video -->
        <button class="tool-button" onclick="showRecordingDialog('audio')" id="audioRecordButton" title="Grabar audio">
            <i class="fas fa-microphone"></i>
        </button>
        <button class="tool-button" onclick="showRecordingDialog('video')" id="videoRecordButton" title="Grabar video">
            <i class="fas fa-camera"></i>
        </button>
    </div>
</div>

<!-- Contenido de previsualización -->
<div id="preview" class="preview-content">
    <div class="logo-container1">
        <img src="https://www.henryford.edu.ar/uploads/logo512_f4b4cdb9e9.png" alt="Logo Henry Ford">
    </div>
    
    <div id="contenidoRubrica" contenteditable="true"></div>
</div>
      <style>
/* Estilos para diálogos personalizados */
.custom-dialog-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    backdrop-filter: blur(3px);
}

.custom-dialog {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    z-index: 1001;
    width: 90%;
    max-width: 500px;
}

.custom-dialog h3 {
    margin-top: 0;
    color: #007bff;
    margin-bottom: 20px;
}

.custom-dialog-content {
    margin-bottom: 20px;
}

.custom-dialog input[type="text"],
.custom-dialog input[type="url"] {
    width: 100%;
    padding: 8px;
    margin-bottom: 15px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}

.custom-dialog input[type="text"]:focus,
.custom-dialog input[type="url"]:focus {
    border-color: #007bff;
    outline: none;
    box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
}

.error-message {
    color: #dc3545;
    font-size: 14px;
    margin-top: -10px;
    margin-bottom: 10px;
    display: none;
}

.dialog-buttons {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

.dialog-button {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s;
}

.dialog-button-primary {
    background: #007bff;
    color: white;
}

.dialog-button-primary:hover {
    background: #0056b3;
}

.dialog-button-secondary {
    background: #6c757d;
    color: white;
}

.dialog-button-secondary:hover {
    background: #545b62;
}

/* Estilos para el diálogo de medios */
.media-dialog {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    z-index: 1000;
    width: 90%;
    max-width: 600px;
    min-height: 200px;
}

.media-dialog-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 999;
}

.media-preview-container {
    margin: 15px 0;
    text-align: center;
}

.media-preview-container img,
.media-preview-container video,
.media-preview-container iframe {
    max-width: 100%;
    max-height: 400px;
    margin: auto;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.media-preview-container audio {
    width: 100%;
}
</style>

<!-- Diálogo para enlaces -->
<div id="linkDialogOverlay" class="custom-dialog-overlay"></div>
<div id="linkDialog" class="custom-dialog">
    <h3>Insertar enlace</h3>
    <div class="custom-dialog-content">
        <input type="url" id="linkUrl" placeholder="Ingresa la URL del enlace">
        <div id="linkUrlError" class="error-message">Por favor, ingresa una URL válida</div>
        <input type="text" id="linkText" placeholder="Texto para mostrar">
    </div>
    <div class="dialog-buttons">
        <button class="dialog-button dialog-button-secondary" onclick="closeCustomDialog('linkDialog')">Cancelar</button>
        <button class="dialog-button dialog-button-primary" onclick="insertCustomLink()">Insertar</button>
    </div>
</div>

<!-- Diálogo para imágenes -->
<div id="imageDialogOverlay" class="custom-dialog-overlay"></div>
<div id="imageDialog" class="custom-dialog">
    <h3>Insertar imagen</h3>
    <div class="custom-dialog-content">
        <input type="url" id="imageUrl" placeholder="Ingresa la URL de la imagen">
        <div id="imageUrlError" class="error-message">Por favor, ingresa una URL válida</div>
    </div>
    <div class="dialog-buttons">
        <button class="dialog-button dialog-button-secondary" onclick="closeCustomDialog('imageDialog')">Cancelar</button>
        <button class="dialog-button dialog-button-primary" onclick="insertCustomImage()">Insertar</button>
    </div>
</div>

<!-- Diálogo para videos -->
<div id="videoDialogOverlay" class="custom-dialog-overlay"></div>
<div id="videoDialog" class="custom-dialog">
    <h3>Insertar video</h3>
    <div class="custom-dialog-content">
        <input type="url" id="videoUrl" placeholder="Ingresa la URL del video (YouTube o URL directa)">
        <div id="videoUrlError" class="error-message">Por favor, ingresa una URL válida</div>
    </div>
    <div class="dialog-buttons">
        <button class="dialog-button dialog-button-secondary" onclick="closeCustomDialog('videoDialog')">Cancelar</button>
        <button class="dialog-button dialog-button-primary" onclick="insertCustomVideo()">Insertar</button>
    </div>
</div>

<!-- Diálogo para iframes -->
<div id="iframeDialogOverlay" class="custom-dialog-overlay"></div>
<div id="iframeDialog" class="custom-dialog">
    <h3>Insertar iframe</h3>
    <div class="custom-dialog-content">
        <input type="url" id="iframeUrl" placeholder="Ingresa la URL para el iframe">
        <input type="text" id="iframeWidth" placeholder="Ancho (ejemplo: 100% o 600px)" value="100%">
        <input type="text" id="iframeHeight" placeholder="Alto (ejemplo: 400px)" value="400px">
        <div id="iframeUrlError" class="error-message">Por favor, ingresa una URL válida</div>
    </div>
    <div class="dialog-buttons">
        <button class="dialog-button dialog-button-secondary" onclick="closeCustomDialog('iframeDialog')">Cancelar</button>
        <button class="dialog-button dialog-button-primary" onclick="insertCustomIframe()">Insertar</button>
    </div>
</div>
      <script>
// Parte 1: Funciones principales del editor
// Función principal de formateo de texto con soporte para fórmulas
function formatearTexto(texto) {
    let formatoHTML = texto;

    // Preservar fórmulas matemáticas primero
    const formulas = [];
    let index = 0;

    // Guardar fórmulas en bloque
    formatoHTML = formatoHTML.replace(/\$\$([\s\S]*?)\$\$/g, function(match) {
        formulas.push(match);
        return `##FORMULA${index++}##`;
    });

    // Guardar fórmulas inline
    formatoHTML = formatoHTML.replace(/\$([\s\S]*?)\$/g, function(match) {
        formulas.push(match);
        return `##FORMULA${index++}##`;
    });

    // Procesar las tablas en su lugar
    let lines = formatoHTML.split('\n');
    let newLines = [];
    let tableLines = [];
    let inTable = false;

    for (let i = 0; i < lines.length; i++) {
        let line = lines[i].trim();
        
        if (line.startsWith('|')) {
            if (!inTable) {
                inTable = true;
                tableLines = [];
                tableLines.push(line);
            } else {
                tableLines.push(line);
            }
        } else {
            if (inTable) {
                // Construir la tabla HTML
                let tableHTML = '<table class="rubrica-tabla">\n';
                let isHeader = true;
                
                tableLines.forEach((tableLine, index) => {
                    // Ignorar líneas de separación (que contienen ---)
                    if (!tableLine.includes('---')) {
                        let cells = tableLine.split('|')
                            .filter(cell => cell.trim() !== '')
                            .map(cell => cell.trim());
                            
                        tableHTML += '<tr>';
                        cells.forEach(cell => {
                            let cellContent = cell
                                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                                .replace(/\*(.*?)\*/g, '<em>$1</em>');
                                
                            if (isHeader) {
                                tableHTML += `<th>${cellContent}</th>`;
                            } else {
                                tableHTML += `<td>${cellContent}</td>`;
                            }
                        });
                        tableHTML += '</tr>\n';
                        isHeader = false;
                    }
                });
                
                tableHTML += '</table>';
                newLines.push(tableHTML);
                inTable = false;
            }
            newLines.push(line);
        }
    }
    
    // Si la última línea era parte de una tabla
    if (inTable) {
        let tableHTML = '<table class="rubrica-tabla">\n';
        let isHeader = true;
        
        tableLines.forEach((tableLine, index) => {
            if (!tableLine.includes('---')) {
                let cells = tableLine.split('|')
                    .filter(cell => cell.trim() !== '')
                    .map(cell => cell.trim());
                    
                tableHTML += '<tr>';
                cells.forEach(cell => {
                    let cellContent = cell
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                        .replace(/\*(.*?)\*/g, '<em>$1</em>');
                        
                    if (isHeader) {
                        tableHTML += `<th>${cellContent}</th>`;
                    } else {
                        tableHTML += `<td>${cellContent}</td>`;
                    }
                });
                tableHTML += '</tr>\n';
                isHeader = false;
            }
        });
        
        tableHTML += '</table>';
        newLines.push(tableHTML);
    }

    formatoHTML = newLines.join('\n');

    // Procesar formato normal
    formatoHTML = formatoHTML
        .replace(/^#### (.*$)/gm, '<h4>$1</h4>')
        .replace(/^### (.*$)/gm, '<h3>$1</h3>')
        .replace(/^## (.*$)/gm, '<h2>$1</h2>')
        .replace(/^# (.*$)/gm, '<h1>$1</h1>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/^\s*[-*]\s+(.+)$/gm, '<li>$1</li>')
        .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>')
        .replace(/\n\n/g, '<br><br>');

    // Restaurar fórmulas
    formulas.forEach((formula, i) => {
        formatoHTML = formatoHTML.replace(`##FORMULA${i}##`, 
            `<div class="math-formula">${formula}</div>`);
    });

    return formatoHTML;
}

// Función para aplicar comandos de formato
function formatText(command) {
    const contentDiv = document.getElementById('contenidoRubrica');
    contentDiv.focus();
    if (command === 'h1' || command === 'h2' || command === 'h3' || command === 'h4') {
        document.execCommand('formatBlock', false, command.toUpperCase());
    } else {
        document.execCommand(command, false, null);
    }
}

// Función para cambiar el color del texto
function changeColor(color) {
    const contentDiv = document.getElementById('contenidoRubrica');
    contentDiv.focus();
    document.execCommand('foreColor', false, color);
}

// Función para aplicar resaltado
function applyHighlight() {
    const contentDiv = document.getElementById('contenidoRubrica');
    contentDiv.focus();
    const color = document.getElementById('highlightColorPicker').value;
    document.execCommand('hiliteColor', false, color);
}

// Función para cambiar el tamaño de fuente
function changeFontSize(size) {
    const contentDiv = document.getElementById('contenidoRubrica');
    contentDiv.focus();

    document.execCommand('styleWithCSS', false, true);
    
    let fontSize;
    switch (size) {
        case '1': fontSize = '8px'; break;
        case '2': fontSize = '10px'; break;
        case '3': fontSize = '12px'; break;
        case '4': fontSize = '16px'; break;
        case '5': fontSize = '18px'; break;
        case '6': fontSize = '24px'; break;
        case '7': fontSize = '32px'; break;
        default: fontSize = '12px';
    }

    document.execCommand('fontSize', false, '7');
    const fontElements = contentDiv.querySelectorAll('font[size="7"]');
    fontElements.forEach(element => {
        element.removeAttribute('size');
        element.style.fontSize = fontSize;
    });
}

       
// Función para previsualizar el contenido
function previsualizarContenido() {
    const texto = document.getElementById('rubricaInput').value;
    if (!texto.trim()) {
        alert('Por favor, pegá el texto antes de previsualizar.');
        return;
    }

    const preview = document.getElementById('preview');
    const contenidoRubrica = document.getElementById('contenidoRubrica');
    
    // Asegurarse que el contenido sea editable
    contenidoRubrica.setAttribute('contenteditable', 'true');
    
    // Limpiar y establecer el nuevo contenido
    contenidoRubrica.innerHTML = formatearTexto(texto);
    
    // Mostrar la previsualización
    preview.style.display = 'block';
    
    // Renderizar fórmulas matemáticas si están disponibles
    if (window.MathJax && typeof MathJax.typesetPromise === 'function') {
        MathJax.typesetPromise([preview])
            .then(() => {
                preview.scrollIntoView({ behavior: 'smooth' });
            })
            .catch((err) => console.error('Error al renderizar fórmulas:', err));
    } else {
        preview.scrollIntoView({ behavior: 'smooth' });
    }
}

// Función para imprimir el contenido
function imprimirContenido() {
    const preview = document.getElementById('preview');
    const contenidoRubrica = document.getElementById('contenidoRubrica');
    
    if (preview.style.display === 'none') {
        alert('Por favor, previsualiza el contenido antes de imprimir.');
        return;
    }

    const ventanaImprimir = window.open('', '_blank');
    ventanaImprimir.document.write(`
        <html>
        <head>
            <title>Material Didáctico</title>
            <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"><\/script>
            <script>
                window.MathJax = {
                    tex: {
                        inlineMath: [['$', '$'], ['\\\\(', '\\\\)']],
                        displayMath: [['$$', '$$'], ['\\\\[', '\\\\]']],
                        processEscapes: true,
                        tags: 'none'
                    },
                    svg: {
                        fontCache: 'global'
                    },
                    startup: {
                        pageReady: () => {
                            return MathJax.startup.defaultPageReady().then(() => {
                                setTimeout(function() {
                                    window.print();
                                    window.close();
                                }, 1000);
                            });
                        }
                    }
                };
            <\/script>
            <style>
                @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');
                body { 
                    font-family: 'Roboto', sans-serif; 
                    padding: 20px;
                    color: inherit;
                }
                * { 
                    -webkit-print-color-adjust: exact !important;
                    color-adjust: exact !important;
                    print-color-adjust: exact !important;
                }
                img { max-width: 100%; height: auto; }
                iframe, video, audio { max-width: 100%; }
                .logo-container1 { text-align: center; margin-bottom: 20px; }
                .logo-container1 img { width: 60px; }
                h1, h2, h3, h4 { color: #007bff; }
                a { color: #007bff; }
                .math-formula { 
                    margin: 1em 0;
                    page-break-inside: avoid;
                }
                table { 
                    border-collapse: collapse; 
                    width: 100%; 
                    margin: 20px 0;
                    page-break-inside: avoid;
                }
                th, td { 
                    border: 1px solid #ddd; 
                    padding: 12px; 
                    text-align: left;
                }
                th { background-color: #f8f9fa; }
                tr:nth-child(even) { background-color: #f9f9f9; }
                .media-container {
                    margin: 10px 0;
                    max-width: 100%;
                }
                .media-container iframe {
                    border: none;
                    max-width: 100%;
                }
                @media print {
                    .no-print { display: none !important; }
                    iframe { max-height: none !important; }
                }
            </style>
        </head>
        <body>
            <div class="logo-container1">
                <img src="https://www.henryford.edu.ar/uploads/logo512_f4b4cdb9e9.png" alt="Logo Henry Ford">
            </div>
            ${contenidoRubrica.innerHTML}
        </body>
        </html>
    `);
    
    ventanaImprimir.document.close();
}

// Función para borrar el contenido
function borrarContenido() {
    document.getElementById('rubricaInput').value = '';
    document.getElementById('contenidoRubrica').innerHTML = '';
    document.getElementById('preview').style.display = 'none';
}

// Función para validar URLs
function validateUrl(url) {
    try {
        new URL(url);
        return true;
    } catch {
        return false;
    }
}

// Función para mostrar/cerrar diálogos personalizados
function showCustomDialog(dialogId) {
    document.getElementById(dialogId + 'Overlay').style.display = 'block';
    document.getElementById(dialogId).style.display = 'block';
    // Limpiar campos y errores
    const inputs = document.querySelectorAll(`#${dialogId} input`);
    inputs.forEach(input => input.value = '');
    const errors = document.querySelectorAll(`#${dialogId} .error-message`);
    errors.forEach(error => error.style.display = 'none');
}

function closeCustomDialog(dialogId) {
    document.getElementById(dialogId + 'Overlay').style.display = 'none';
    document.getElementById(dialogId).style.display = 'none';
}

// Event Listener para previsualización automática
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('rubricaInput').addEventListener('input', function() {
        const preview = document.getElementById('preview');
        const contenidoRubrica = document.getElementById('contenidoRubrica');
        
        if (this.value.trim()) {
            contenidoRubrica.innerHTML = formatearTexto(this.value);
            preview.style.display = 'block';
            // Renderizar fórmulas matemáticas
            if (window.MathJax) {
                MathJax.typesetPromise().catch((err) => 
                    console.log('Error al renderizar fórmulas:', err));
            }
        } else {
            preview.style.display = 'none';
        }
    });

    // Event listener para barra de herramientas fija
    window.addEventListener('scroll', function() {
        const toolbar = document.querySelector('.editor-toolbar');
        if (window.scrollY > 200) {
            toolbar.classList.add('sticky');
        } else {
            toolbar.classList.remove('sticky');
        }
    });
});

// Funciones para manejo de enlaces
function insertLink() {
    // Prevenir el diálogo predeterminado del navegador
    event.preventDefault();
    
    // Guardar la selección actual
    const selection = window.getSelection();
    const range = selection.getRangeAt(0);
    const selectedText = range.toString();
    
    // Mostrar el diálogo personalizado
    document.getElementById('linkDialogOverlay').style.display = 'block';
    document.getElementById('linkDialog').style.display = 'block';
    
    // Pre-llenar el texto seleccionado si existe
    document.getElementById('linkText').value = selectedText;
    document.getElementById('linkUrl').value = '';
    document.getElementById('linkUrlError').style.display = 'none';
}

function insertCustomLink() {
    const url = document.getElementById('linkUrl').value;
    const text = document.getElementById('linkText').value;
    
    if (!validateUrl(url)) {
        document.getElementById('linkUrlError').style.display = 'block';
        return;
    }
    
    const contentDiv = document.getElementById('contenidoRubrica');
    contentDiv.focus();
    
    // Crear el enlace HTML
    const linkHtml = `<a href="${url}" target="_blank">${text || url}</a>`;
    
    // Insertar el enlace
    document.execCommand('insertHTML', false, linkHtml);
    
    // Cerrar el diálogo
    closeCustomDialog('linkDialog');
}

// Funciones para manejo de imágenes
function insertImage() {
    event.preventDefault();
    showCustomDialog('imageDialog');
}

function insertCustomImage() {
    const url = document.getElementById('imageUrl').value;
    
    if (!validateUrl(url)) {
        document.getElementById('imageUrlError').style.display = 'block';
        return;
    }

    const contentDiv = document.getElementById('contenidoRubrica');
    contentDiv.focus();
    document.execCommand('insertHTML', false, 
        `<div class="media-container"><img src="${url}" alt="Imagen insertada" style="max-width:100%;"></div>`);
    closeCustomDialog('imageDialog');
}

// Función para obtener ID de YouTube
function getYouTubeVideoId(url) {
    const regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#\&\?]*).*/;
    const match = url.match(regExp);
    return (match && match[7].length == 11) ? match[7] : null;
}

// Funciones para manejo de videos
function insertVideo() {
    event.preventDefault();
    showCustomDialog('videoDialog');
}

function insertCustomVideo() {
    const url = document.getElementById('videoUrl').value;
    
    if (!validateUrl(url)) {
        document.getElementById('videoUrlError').style.display = 'block';
        return;
    }

    let html = '';
    if (url.includes('youtube.com') || url.includes('youtu.be')) {
        const videoId = getYouTubeVideoId(url);
        if (videoId) {
            html = `<div class="media-container"><iframe width="560" height="315" 
                src="https://www.youtube.com/embed/${videoId}" 
                frameborder="0" allowfullscreen></iframe></div>`;
        }
    } else {
        html = `<div class="media-container"><video src="${url}" controls style="max-width:100%;"></video></div>`;
    }

    const contentDiv = document.getElementById('contenidoRubrica');
    contentDiv.focus();
    document.execCommand('insertHTML', false, html);
    closeCustomDialog('videoDialog');
}

// Funciones para manejo de iframes
function insertIframe() {
    event.preventDefault();
    showCustomDialog('iframeDialog');
}

function insertCustomIframe() {
    const url = document.getElementById('iframeUrl').value;
    const width = document.getElementById('iframeWidth').value;
    const height = document.getElementById('iframeHeight').value;
    
    if (!validateUrl(url)) {
        document.getElementById('iframeUrlError').style.display = 'block';
        return;
    }

    // Validar dimensiones
    const validWidth = /^(\d+)(px|%)?$/.test(width) ? width : '100%';
    const validHeight = /^(\d+)(px|%)?$/.test(height) ? height : '400px';

    const html = `<div class="media-container">
        <iframe src="${url}" 
                style="width: ${validWidth}; height: ${validHeight};" 
                frameborder="0" 
                allowfullscreen>
        </iframe>
    </div>`;

    const contentDiv = document.getElementById('contenidoRubrica');
    contentDiv.focus();
    document.execCommand('insertHTML', false, html);
    closeCustomDialog('iframeDialog');
}

// Función para ajustar elementos multimedia seleccionados
let selectedMedia = null;

function initMediaEvents() {
    const contenidoRubrica = document.getElementById('contenidoRubrica');
    
    contenidoRubrica.addEventListener('click', function(e) {
        const target = e.target;
        if (target.tagName === 'IMG' || target.tagName === 'VIDEO' || 
            target.tagName === 'IFRAME') {
            
            // Deseleccionar el elemento anterior
            if (selectedMedia && selectedMedia !== target) {
                selectedMedia.classList.remove('media-selected');
            }
            
            // Seleccionar el nuevo elemento
            selectedMedia = target;
            selectedMedia.classList.add('media-selected');
            
            // Mostrar la barra de herramientas de medios
            document.querySelector('.media-tools').style.display = 'flex';
            
            // Si el elemento no está en un contenedor, envolverlo en uno
            if (!target.parentElement.classList.contains('media-container')) {
                const container = document.createElement('div');
                container.className = 'media-container';
                target.parentNode.insertBefore(container, target);
                container.appendChild(target);
            }
        } else if (!e.target.closest('.media-tools')) {
            // Si se hace clic fuera del elemento multimedia y de la barra de herramientas
            if (selectedMedia) {
                selectedMedia.classList.remove('media-selected');
                selectedMedia = null;
                document.querySelector('.media-tools').style.display = 'none';
            }
        }
    });
}

// Inicializar eventos cuando el documento esté listo
document.addEventListener('DOMContentLoaded', function() {
    initMediaEvents();
});

// Funciones de ajuste de tamaño para elementos multimedia
function adjustMediaSize(action) {
    if (!selectedMedia) return;
    
    const container = selectedMedia.parentElement;
    let currentWidth;
    let currentHeight;

    // Obtener dimensiones actuales
    if (selectedMedia.tagName === 'IFRAME') {
        // Para iframes, usar el estilo directamente
        currentWidth = parseInt(selectedMedia.style.width) || selectedMedia.offsetWidth;
        currentHeight = parseInt(selectedMedia.style.height) || selectedMedia.offsetHeight;
    } else {
        currentWidth = selectedMedia.width || selectedMedia.offsetWidth;
        currentHeight = selectedMedia.height || selectedMedia.offsetHeight;
    }
    
    // Calcular nuevas dimensiones
    let newWidth, newHeight;
    if (action === 'increase') {
        newWidth = Math.min(currentWidth * 1.1, container.offsetWidth);
        newHeight = currentHeight * (newWidth / currentWidth);
    } else {
        newWidth = Math.max(currentWidth * 0.9, 100); // Mínimo 100px
        newHeight = currentHeight * (newWidth / currentWidth);
    }
    
    // Aplicar nuevas dimensiones
    if (selectedMedia.tagName === 'IFRAME') {
        selectedMedia.style.width = `${newWidth}px`;
        selectedMedia.style.height = `${newHeight}px`;
    } else {
        selectedMedia.style.width = `${newWidth}px`;
        if (selectedMedia.tagName === 'VIDEO') {
            selectedMedia.style.height = `${newHeight}px`;
        }
    }
}

// Función para alinear elementos multimedia
function alignMedia(alignment) {
    if (!selectedMedia) return;
    
    const container = selectedMedia.parentElement;
    
    // Remover clases de alineación existentes
    container.classList.remove('align-left', 'align-center', 'align-right');
    
    // Aplicar nueva alineación
    container.classList.add(`align-${alignment}`);
    
    // Actualizar estilos del contenedor según la alineación
    if (alignment === 'center') {
        container.style.float = 'none';
        container.style.display = 'block';
        container.style.marginLeft = 'auto';
        container.style.marginRight = 'auto';
    } else {
        container.style.float = alignment;
        container.style.display = 'inline-block';
        container.style.marginLeft = alignment === 'right' ? '20px' : '0';
        container.style.marginRight = alignment === 'left' ? '20px' : '0';
    }
}

// Función para manejar el redimensionamiento con el mouse
function initResizeHandlers() {
    const contenidoRubrica = document.getElementById('contenidoRubrica');
    let isResizing = false;
    let currentResizeTarget = null;
    let originalWidth;
    let originalHeight;
    let originalX;
    let originalY;

    // Agregar los manejadores de redimensionamiento a elementos multimedia
    function addResizeHandle(element) {
        const handle = document.createElement('div');
        handle.className = 'resize-handle';
        element.parentElement.style.position = 'relative';
        element.parentElement.appendChild(handle);
        
        handle.addEventListener('mousedown', function(e) {
            isResizing = true;
            currentResizeTarget = element;
            originalWidth = element.offsetWidth;
            originalHeight = element.offsetHeight;
            originalX = e.clientX;
            originalY = e.clientY;
            e.preventDefault();
        });
    }

    // Manejar el movimiento del mouse durante el redimensionamiento
    document.addEventListener('mousemove', function(e) {
        if (!isResizing) return;

        const deltaX = e.clientX - originalX;
        const deltaY = e.clientY - originalY;
        const newWidth = originalWidth + deltaX;
        const newHeight = originalHeight + deltaY;

        if (currentResizeTarget && newWidth > 100) { // Mínimo 100px de ancho
            currentResizeTarget.style.width = `${newWidth}px`;
            
            // Mantener proporción para videos e iframes
            if (currentResizeTarget.tagName === 'VIDEO' || 
                currentResizeTarget.tagName === 'IFRAME') {
                currentResizeTarget.style.height = `${newHeight}px`;
            }
        }
    });

    // Detener el redimensionamiento al soltar el mouse
    document.addEventListener('mouseup', function() {
        isResizing = false;
        currentResizeTarget = null;
    });

    // Observer para agregar manejadores a nuevos elementos multimedia
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            mutation.addedNodes.forEach(function(node) {
                if (node.nodeType === 1) { // Elemento NODE
                    if (node.matches('img, video, iframe')) {
                        addResizeHandle(node);
                    } else {
                        node.querySelectorAll('img, video, iframe').forEach(addResizeHandle);
                    }
                }
            });
        });
    });

    // Configurar y comenzar la observación
    observer.observe(contenidoRubrica, {
        childList: true,
        subtree: true
    });

    // Agregar manejadores a elementos existentes
    contenidoRubrica.querySelectorAll('img, video, iframe').forEach(addResizeHandle);
}

// Función para mostrar/ocultar manejadores de redimensionamiento
function toggleResizeHandles(show) {
    const handles = document.querySelectorAll('.resize-handle');
    handles.forEach(handle => {
        handle.style.display = show ? 'block' : 'none';
    });
}

// Establecer el estado inicial de los manejadores de redimensionamiento
document.addEventListener('DOMContentLoaded', function() {
    initResizeHandlers();
    
    // Mostrar manejadores solo cuando el mouse está sobre el elemento
    document.addEventListener('mouseover', function(e) {
        if (e.target.matches('img, video, iframe')) {
            const handle = e.target.parentElement.querySelector('.resize-handle');
            if (handle) handle.style.display = 'block';
        }
    });

    document.addEventListener('mouseout', function(e) {
        if (e.target.matches('img, video, iframe')) {
            const handle = e.target.parentElement.querySelector('.resize-handle');
            if (handle && !isResizing) handle.style.display = 'none';
        }
    });
});

// Variables globales para grabación
let mediaRecorder = null;
let recordedChunks = [];
let mediaStream = null;
let timerInterval = null;
let startTime = null;
let recordingType = null;

// Función principal de grabación
async function startRecording(type) {
    try {
        if (mediaRecorder && mediaRecorder.state === 'recording') {
            return;
        }

        // Verificar soporte de API
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            throw new Error('Tu navegador no soporta la grabación de medios. Por favor, usa Chrome, Firefox o Edge actualizado.');
        }

        // Configurar restricciones según el tipo
        const constraints = {
            audio: {
                echoCancellation: true,
                noiseSuppression: true,
                sampleRate: 44100
            },
            video: type === 'video' ? {
                width: { ideal: 1280 },
                height: { ideal: 720 },
                facingMode: 'user'
            } : false
        };

        try {
            mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
        } catch (permissionError) {
            if (permissionError.name === 'NotAllowedError') {
                throw new Error('Por favor, permite el acceso a tu ' + 
                    (type === 'video' ? 'cámara y micrófono' : 'micrófono') + ' para continuar.');
            } else if (permissionError.name === 'NotFoundError') {
                throw new Error('No se encontró ningún dispositivo de ' + 
                    (type === 'video' ? 'video/audio' : 'audio') + '. Por favor, verifica que esté conectado correctamente.');
            } else {
                throw permissionError;
            }
        }
        
        // Configurar vista previa de video
        if (type === 'video') {
            const videoPreview = document.getElementById('videoPreview');
            videoPreview.srcObject = mediaStream;
            await videoPreview.play();
        }
        
        // Intentar diferentes códecs
        let options = {};
        const mimeTypes = type === 'video' 
            ? ['video/webm;codecs=vp8,opus', 'video/webm', 'video/mp4']
            : ['audio/webm;codecs=opus', 'audio/webm', 'audio/mp4'];
            
        for (const mimeType of mimeTypes) {
            if (MediaRecorder.isTypeSupported(mimeType)) {
                options = { mimeType };
                break;
            }
        }

        // Crear MediaRecorder
        mediaRecorder = new MediaRecorder(mediaStream, options);
        recordedChunks = [];
        recordingType = type;
        
        // Configurar eventos del MediaRecorder
        mediaRecorder.ondataavailable = (e) => {
            if (e.data.size > 0) {
                recordedChunks.push(e.data);
            }
        };
        
        mediaRecorder.onstop = () => {
            const blob = new Blob(recordedChunks, {
                type: mediaRecorder.mimeType
            });
            const url = URL.createObjectURL(blob);
            const preview = document.getElementById(`${type}Preview`);
            preview.src = url;
            preview.srcObject = null;
            
            // Actualizar interfaz
            document.getElementById(`start${type.charAt(0).toUpperCase() + type.slice(1)}Record`).style.display = 'none';
            document.getElementById(`stop${type.charAt(0).toUpperCase() + type.slice(1)}Record`).style.display = 'none';
            document.getElementById(`save${type.charAt(0).toUpperCase() + type.slice(1)}Record`).style.display = 'inline-flex';
            
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        };
        
        // Iniciar grabación
        mediaRecorder.start(1000);
        startTime = new Date();
        timerInterval = setInterval(() => updateTimer(`${type}Timer`), 1000);
        
        // Actualizar interfaz
        document.getElementById(`${type}Status`).textContent = 'Grabando...';
        document.getElementById(`start${type.charAt(0).toUpperCase() + type.slice(1)}Record`).style.display = 'none';
        document.getElementById(`stop${type.charAt(0).toUpperCase() + type.slice(1)}Record`).style.display = 'inline-flex';
        
    } catch (error) {
        console.error('Error al iniciar la grabación:', error);
        const errorElement = document.getElementById(`${type}Error`);
        errorElement.textContent = error.message;
        errorElement.style.display = 'block';
        
        if (mediaStream) {
            stopMediaStream();
        }
    }
}

// Función para detener la grabación
function stopRecording() {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
        stopMediaStream();
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
        document.getElementById(`${recordingType}Status`).textContent = 'Grabación completada';
    }
}

// Función para guardar la grabación
function saveRecording() {
    if (recordedChunks.length === 0) return;
    
    const blob = new Blob(recordedChunks, {
        type: recordingType === 'video' ? 'video/webm' : 'audio/webm'
    });
    const url = URL.createObjectURL(blob);
    
    const contentDiv = document.getElementById('contenidoRubrica');
    contentDiv.focus();
    
    const mediaElement = recordingType === 'video' 
        ? `<div class="media-container"><video src="${url}" controls style="max-width:100%;"></video></div>`
        : `<div class="media-container"><audio src="${url}" controls></audio></div>`;
    
    document.execCommand('insertHTML', false, mediaElement);
    closeRecordingDialog(recordingType);
}

// Funciones auxiliares de grabación
function stopMediaStream() {
    if (mediaStream) {
        mediaStream.getTracks().forEach(track => track.stop());
        mediaStream = null;
    }
}

function updateTimer(timerId) {
    const now = new Date();
    const diff = now - startTime;
    const minutes = Math.floor(diff / 60000);
    const seconds = Math.floor((diff % 60000) / 1000);
    document.getElementById(timerId).textContent = 
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

// Funciones de diálogo de grabación
function showRecordingDialog(type) {
    recordingType = type;
    const dialogId = `${type}RecordingDialog`;
    const overlayId = `${type}RecordingOverlay`;
    
    document.getElementById(overlayId).style.display = 'block';
    document.getElementById(dialogId).style.display = 'block';
    
    // Resetear interfaz
    document.getElementById(`${type}Timer`).textContent = '00:00';
    document.getElementById(`${type}Status`).textContent = 
        'El navegador solicitará permisos para acceder a tu ' + 
        (type === 'video' ? 'cámara y micrófono' : 'micrófono') + 
        '. Por favor, permite el acceso cuando se te solicite.';
    document.getElementById(`${type}Error`).style.display = 'none';
    document.getElementById(`start${type.charAt(0).toUpperCase() + type.slice(1)}Record`).style.display = 'inline-flex';
    document.getElementById(`stop${type.charAt(0).toUpperCase() + type.slice(1)}Record`).style.display = 'none';
    document.getElementById(`save${type.charAt(0).toUpperCase() + type.slice(1)}Record`).style.display = 'none';
    
    const preview = document.getElementById(`${type}Preview`);
    preview.srcObject = null;
    preview.src = '';
}

function closeRecordingDialog(type) {
    const dialogId = `${type}RecordingDialog`;
    const overlayId = `${type}RecordingOverlay`;
    
    document.getElementById(dialogId).style.display = 'none';
    document.getElementById(overlayId).style.display = 'none';
    
    if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
    }
    
    stopMediaStream();
    
    if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
    }
    
    // Resetear interfaz
    document.getElementById(`${type}Timer`).textContent = '00:00';
    document.getElementById(`${type}Status`).textContent = 'Listo para grabar';
    document.getElementById(`${type}Error`).style.display = 'none';
    
    const preview = document.getElementById(`${type}Preview`);
    preview.srcObject = null;
    preview.src = '';
}

// Variables globales para el autoguardado
let autoSaveInterval = null;
const AUTO_SAVE_DELAY = 30000; // 30 segundos

// Función para descargar el contenido
function descargarContenido() {
    const preview = document.getElementById('preview');
    const contenidoRubrica = document.getElementById('contenidoRubrica');
    
    if (preview.style.display === 'none') {
        alert('Por favor, previsualiza el contenido antes de descargar.');
        return;
    }

    const htmlContent = `<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Material Didáctico</title>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"><\/script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\\\(', '\\\\)']],
                displayMath: [['$$', '$$'], ['\\\\[', '\\\\]']],
                processEscapes: true,
                tags: 'none'
            },
            svg: {
                fontCache: 'global'
            }
        };
    <\/script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');
        body { 
            font-family: 'Roboto', sans-serif; 
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        img { max-width: 100%; height: auto; }
        iframe, video, audio { max-width: 100%; }
        .logo-container { text-align: center; margin-bottom: 20px; }
        .logo-container img { width: 80px; }
        h1, h2, h3, h4 { color: #007bff; }
        a { color: #007bff; }
        .math-formula { margin: 1em 0; }
        table { 
            border-collapse: collapse; 
            width: 100%; 
            margin: 20px 0;
        }
        th, td { 
            border: 1px solid #ddd; 
            padding: 12px; 
            text-align: left;
        }
        th { background-color: #f8f9fa; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        .media-container {
            margin: 10px 0;
            max-width: 100%;
        }
        .media-container img,
        .media-container video,
        .media-container audio,
        .media-container iframe {
            max-width: 100%;
        }
        .media-container.align-left { float: left; margin-right: 20px; }
        .media-container.align-center { display: block; margin: 0 auto; text-align: center; }
        .media-container.align-right { float: right; margin-left: 20px; }
    </style>
</head>
<body>
    <div class="logo-container">
        <img src="https://www.henryford.edu.ar/uploads/logo512_f4b4cdb9e9.png" alt="Logo Henry Ford">
    </div>
    
    ${contenidoRubrica.innerHTML}
</body>
</html>`;

    const blob = new Blob([htmlContent], { type: 'text/html' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    const timestamp = new Date().toISOString().slice(0,19).replace(/:/g, '-');
    a.download = `material_didactico_${timestamp}.html`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

// Función para guardar el estado actual
function saveCurrentState() {
    const content = {
        input: document.getElementById('rubricaInput').value,
        preview: document.getElementById('contenidoRubrica').innerHTML,
        timestamp: new Date().toISOString()
    };
    
    try {
        localStorage.setItem('editorState', JSON.stringify(content));
        return true;
    } catch (error) {
        console.error('Error al guardar el estado:', error);
        return false;
    }
}

// Función para restaurar el último estado guardado
function restoreLastState() {
    try {
        const savedState = localStorage.getItem('editorState');
        if (savedState) {
            const content = JSON.parse(savedState);
            document.getElementById('rubricaInput').value = content.input;
            document.getElementById('contenidoRubrica').innerHTML = content.preview;
            document.getElementById('preview').style.display = 'block';
            return true;
        }
    } catch (error) {
        console.error('Error al restaurar el estado:', error);
    }
    return false;
}

// Función para habilitar el autoguardado
function enableAutoSave() {
    if (autoSaveInterval) {
        clearInterval(autoSaveInterval);
    }
    
    autoSaveInterval = setInterval(() => {
        if (saveCurrentState()) {
            const indicator = document.querySelector('.autosave-indicator');
            if (indicator) {
                indicator.textContent = 'Guardado automático: ' + new Date().toLocaleTimeString();
                indicator.classList.add('visible');
                setTimeout(() => {
                    indicator.classList.remove('visible');
                }, 2000);
            }
        }
    }, AUTO_SAVE_DELAY);
}

// Función para deshabilitar el autoguardado
function disableAutoSave() {
    if (autoSaveInterval) {
        clearInterval(autoSaveInterval);
        autoSaveInterval = null;
    }
}

// Inicializar funciones cuando el documento esté listo
document.addEventListener('DOMContentLoaded', function() {
    // Intentar restaurar el último estado guardado
    restoreLastState();
    
    // Habilitar autoguardado
    enableAutoSave();
    
    // Manejar eventos de cierre de ventana
    window.addEventListener('beforeunload', function(e) {
        if (document.getElementById('rubricaInput').value.trim() !== '') {
            e.preventDefault();
            e.returnValue = '';
        }
    });
    
    // Inicializar todos los eventos necesarios
    initMediaEvents();
    initResizeHandlers();
    
    // Configurar eventos de grabación
    const recordingButtons = {
        audio: ['startAudioRecord', 'stopAudioRecord', 'saveAudioRecord', 'cancelAudioRecord'],
        video: ['startVideoRecord', 'stopVideoRecord', 'saveVideoRecord', 'cancelVideoRecord']
    };
    
    Object.entries(recordingButtons).forEach(([type, buttons]) => {
        buttons.forEach(buttonId => {
            const button = document.getElementById(buttonId);
            if (button) {
                const action = buttonId.replace(type.charAt(0).toUpperCase() + type.slice(1), '').toLowerCase();
                switch (action) {
                    case 'startrecord':
                        button.onclick = () => startRecording(type);
                        break;
                    case 'stoprecord':
                        button.onclick = stopRecording;
                        break;
                    case 'saverecord':
                        button.onclick = saveRecording;
                        break;
                    case 'cancelrecord':
                        button.onclick = () => closeRecordingDialog(type);
                        break;
                }
            }
        });
    });
});
</script>
</body>
</html>
